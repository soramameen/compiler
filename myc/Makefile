#====================================================
# 1. OSの自動検出
#====================================================
# "uname -s" コマンドの結果 (Linux または Darwin) を変数に入れる
UNAME_S := $(shell uname -s)

#====================================================
# 2. 共通設定
#====================================================
SRCS = $(wildcard *.y)
TARGETS = $(SRCS:.y=)
CC = gcc

#====================================================
# 3. OSごとの設定切り替え (if文)
#====================================================

ifeq ($(UNAME_S),Darwin)
    #------------------------------------------------
    # [Mac (Darwin)] の場合
    # brewで入れたFlexの場所を自動取得してパスを通す
    #------------------------------------------------
    FLEX_PATH = $(shell brew --prefix flex)
    
    # ヘッダファイルの場所 (-I)
    CFLAGS = -I$(FLEX_PATH)/include
    
    # ライブラリの場所 (-L) とリンク設定
    LIBS = -L$(FLEX_PATH)/lib -lfl -ly

else
    #------------------------------------------------
    # [Linux] の場合
    # 通常は標準パスにあるので特別な指定は不要
    #------------------------------------------------
    CFLAGS =
    LIBS = -lfl -ly
endif

#====================================================
# 4. メインターゲット
#====================================================
all: $(TARGETS)

#====================================================
# 5. ビルド・ルール
#====================================================
%: %.y %.l
	# 1. Bison
	bison -d $<
	
	# 2. Flex
	flex $*.l
	
	# 3. Compile
	# $(CFLAGS) と $(LIBS) がOSによって自動で切り替わります
	$(CC) $(CFLAGS) $*.tab.c lex.yy.c -o $@ $(LIBS)
	
	# 4. Cleanup
	rm -f $*.tab.c $*.tab.h lex.yy.c

#====================================================
# 6. クリーンアップ
#====================================================
clean:
	rm -f $(TARGETS) *.tab.c *.tab.h lex.yy.c

.PHONY: all clean
